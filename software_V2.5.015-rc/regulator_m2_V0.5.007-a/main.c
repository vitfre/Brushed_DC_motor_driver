/*
 * Delay_line.c
 *
 * Created: 02.02.2014 14:00:29
 *  Author: Администратор
 */ 

#include "main.h"

//---------------------------------------------------------------------------------------
#define ADC_VREF_TYPE 0x00
//---------------------------------------------------------------------------------------
// Read the AD conversion result
unsigned int read_adc(unsigned char adc_input)
{
	ADMUX=(adc_input & 0x0f) | ADC_VREF_TYPE;
	// Delay needed for the stabilization of the ADC input voltage
	_delay_us(10);
	// Start the AD conversion
	ADCSRA|=0x40;
	// Wait for the AD conversion to complete
	while ((ADCSRA & 0x10)==0);
	ADCSRA|=0x10;
	return ADCW;
}
//---------------------------------------------------------------------------------------

//****************************************************************************************
// External Interrupt 0 service routine
//****************************************************************************************
ISR (INT0_vect)
{
	//---------------------------------------------------------------------------------------
	if (PWR_EN==0x00)
	{
		IMP_SEM_CLR_M1
	} 
	else
	{
	};
	//---------------------------------------------------------------------------------------
	return;
};

//****************************************************************************************
// Timer0 overflow interrupt service routine
//****************************************************************************************
ISR (TIMER0_OVF_vect)
{
	//---------------------------------------------------------------------------------------
	IMP_SEM_SET_M1
	//---------------------------------------------------------------------------------------
	return;
};

int main(void)
{
	
	//---------------------------------------------------------------------------------------
	init_periphery ();
	//---------------------------------------------------------------------------------------
	//Global enable interrupts
	sei();
	//---------------------------------------------------------------------------------------
    while(1)
    {
        //TODO:: Please write your application code 
		//---------------------------------------------------------------------------------------
		moderator=read_adc(2)/8;
		//---------------------------------------------------------------------------------------
		while(PWR_EN==0x00)//Двигун увімкнули
		{
			//---------------------------------------------------------------------------------------
			power=((read_adc(2)/8)-moderator);
			if (power>200)
			{
				//---------------------------------------------------------------------------------------
				power=0;
				//---------------------------------------------------------------------------------------
			} 
			else if (power>128)
			{
				//---------------------------------------------------------------------------------------
				power=128;
				//---------------------------------------------------------------------------------------
			};
			power=power+min_power;
			//---------------------------------------------------------------------------------------
			if (moderator!=0x00)
			{
				//---------------------------------------------------------------------------------------
				moderator--;
				//---------------------------------------------------------------------------------------
			};
			//---------------------------------------------------------------------------------------
			_delay_ms(10);
			//---------------------------------------------------------------------------------------
		}
		//---------------------------------------------------------------------------------------
		while(PWR_EN==0x01)//Двигун вимкнули
		{
			//---------------------------------------------------------------------------------------
			SPOP_M1
			//---------------------------------------------------------------------------------------
			_delay_ms(15);
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
    };
};